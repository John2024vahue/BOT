import os
import sqlite3
import json
from dotenv import load_dotenv

load_dotenv()

BOT_TOKEN = os.getenv('BOT_TOKEN')
if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN не найден в .env файле")

ADMIN_ID = int(os.getenv('ADMIN_ID', '6830411048'))
WEBHOOK_URL = os.getenv('WEBHOOK_URL', 'https://your-railway-app.up.railway.app/webhook')

# ID реальных Telegram групп
GROUP_IDS = {
    "Образование и Саморазвитие": "-1003433439121",
    "Наука и литература": "-1002820402117", 
    "Программирование": "-1003477061325",
    "Экономика и Бизнес": "-1003382139382",
    "Здоровье и медицина": "-1003305866632",
    "Искусство и музыка": "-1003378596165",
    "Кулинария и рецепты": "-1003210673239",
    "Путешествие и туризм": "-1003340734939",
    "Спорт": "-1003300649893",
    "Иное": "-1003307595772"
}

def init_database():
    """Инициализация базы данных"""
    db_path = 'bot_database.db'
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # Таблица пользователей
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        last_active TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        language TEXT DEFAULT 'ru'
    )
    ''')

    # Таблица чатов
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS chats (
        chat_id INTEGER PRIMARY KEY AUTOINCREMENT,
        chat_name TEXT UNIQUE,
        telegram_group_id TEXT,
        member_count INTEGER DEFAULT 0,
        is_active BOOLEAN DEFAULT TRUE,
        keywords TEXT DEFAULT '[]'
    )
    ''')

    # Таблица участия пользователей в чатах
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS user_chats (
        user_id INTEGER,
        chat_id INTEGER,
        join_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (user_id),
        FOREIGN KEY (chat_id) REFERENCES chats (chat_id),
        PRIMARY KEY (user_id, chat_id)
    )
    ''')

    # Таблица пула интересов
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS interest_pool (
        user_id INTEGER,
        topic_name TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        status TEXT DEFAULT 'pending',
        FOREIGN KEY (user_id) REFERENCES users (user_id)
    )
    ''')

    # Добавляем предопределенные темы
    for topic, group_id in GROUP_IDS.items():
        cursor.execute('''
        INSERT OR IGNORE INTO chats (chat_name, telegram_group_id, keywords) 
        VALUES (?, ?, ?)
        ''', (topic, group_id, json.dumps({
            "Образование и Саморазвитие": ["учеба", "саморазвитие", "книги", "курсы", "образование", "знание", "развитие", "психология", "мышление", "обучение", "университет", "школа", "знания", "самосовершенствование", "мотивация", "цели", "успех"],
            "Наука и литература": ["наука", "литература", "книги", "авторы", "научные", "исследования", "научная", "фантастика", "классика", "поэзия", "проза", "литературные", "критика", "научпоп", "физика", "химия", "биология", "история"],
            "Программирование": ["программирование", "код", "разработка", "python", "javascript", "веб", "мобильные", "приложения", "алгоритмы", "бэкенд", "фронтенд", "дата", "аналитика", "машинное", "обучение", "искусственный", "интеллект", "нейронные", "сети"],
            "Экономика и Бизнес": ["экономика", "бизнес", "финансы", "инвестиции", "стартап", "предпринимательство", "рынок", "деньги", "заработок", "доход", "прибыль", "капитал", "бизнесмен", "предприниматель", "трейдинг", "акции", "валюта", "криптовалюта", "форекс", "недвижимость"],
            "Здоровье и медицина": ["здоровье", "медицина", "фитнес", "питание", "спорт", "йога", "лечение", "профилактика", "психическое", "здоровье", "диета", "витамины", "лекарства", "болезни", "врачи", "психология", "стресс", "сон", "релаксация", "оздоровление"],
            "Искусство и музыка": ["искусство", "музыка", "творчество", "живопись", "рисование", "композиторы", "исполнители", "творческие", "художники", "графика", "скульптура", "архитектура", "классическая", "рок", "джаз", "поп", "эстрада", "инструменты", "гитара", "фортепиано"],
            "Кулинария и рецепты": ["кулинария", "рецепты", "готовка", "еда", "блюда", "ингредиенты", "вкусно", "домашняя", "кухни", "выпечка", "кондитерское", "десерты", "салаты", "супы", "вторые", "блюда", "напитки", "кофе", "чай", "вино"],
            "Путешествие и туризм": ["путешествие", "туризм", "страны", "город", "отдых", "отпуск", "достопримечательности", "экскурсии", "походы", "автомобильные", "туристические", "маршруты", "гостиницы", "отели", "авиабилеты", "визы", "пляж", "море", "горы", "природа", "экзотика", "бюджетные", "дорогие", "туристы"],
            "Спорт": ["спорт", "фитнес", "тренеровка", "чемпионат", "матчи", "здоровье", "физическая", "активность", "командный", "футбол", "баскетбол", "волейбол", "теннис", "плавание", "бег", "велосипед", "единоборства", "бокс", "бои", "тренажерный", "зал", "диета", "питание"],
            "Иное": ["разное", "другое", "всякое", "разное", "общее", "разные", "темы", "обсуждения", "общение", "флуд", "разговоры", "мемы", "юмор", "анекдоты", "интересное", "важное", "актуальное", "новости"]
        }.get(topic, []))))
        
    conn.commit()
    conn.close()
    print("✅ База данных инициализирована")

# Инициализируем базу при импорте
init_database()